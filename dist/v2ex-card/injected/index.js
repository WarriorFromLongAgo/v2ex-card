/*!
 * v2ex-card v1.0.0
 * Github: https://github.com/zhw2590582/v2ex-card
 * (c) 2018-2020 Harvey Zack
 * Released under the MIT License.
 */

var v2exCardInjected=function(){"use strict";var t=function(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,a=new Array(n);e<n;e++)a[e]=t[e];return a};var n=function(n){if(Array.isArray(n))return t(n)};var e=function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)};var a=function(n,e){if(n){if("string"==typeof n)return t(n,e);var a=Object.prototype.toString.call(n).slice(8,-1);return"Object"===a&&n.constructor&&(a=n.constructor.name),"Map"===a||"Set"===a?Array.from(n):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?t(n,e):void 0}};var c=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var i=function(t){return n(t)||e(t)||a(t)||c()};var o=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")};function r(t,n){for(var e=0;e<n.length;e++){var a=n[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}var l=function(t,n,e){return n&&r(t.prototype,n),e&&r(t,e),t};function s(t,n){return t.classList.add(n)}return new(function(){function t(){o(this,t),this.$card=null,this.timeout=null,this.infoCache={},this.current=null,this.domParser=new DOMParser,document.body.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("scroll",this.onScroll.bind(this))}return l(t,[{key:"onMouseMove",value:function(t){var n=this,e=this.getMemberUrl(t);e?this.getMemberInfo(e).then((function(a){n.render(t,e,a)})).catch((function(t){console.warn(t)})):this.$card&&!t.composedPath().includes(this.$card)&&s(this.$card,"vc-hide")}},{key:"onScroll",value:function(){this.$card&&s(this.$card,"vc-hide")}},{key:"getMemberUrl",value:function(t){var n=t.target;return"A"===n.tagName&&/^\/member\//.test(n.pathname||"")?n.pathname:"IMG"===n.tagName&&"avatar"===n.className&&n.alt?"/member/".concat(n.alt):null}},{key:"getInfoFromText",value:function(t){var n=this.domParser.parseFromString(t,"text/html"),e=n.querySelector(".avatar"),a=n.querySelector("#Main .box .gray"),c=e.alt,o=e.src,r=!!n.querySelector("#Main .box .online"),l=a.textContent.match(/\s(\d+)\s/)[1],s=a.textContent.match(/\s(\d{4}-.*\+08:00)/)[1],v=a.querySelector("a"),u=v?v.textContent:"",d=i(n.querySelectorAll("#Main .box .widgets a")).map((function(t){var n=t.querySelector("img");return{href:t.href,img:n?n.src:"",name:t.textContent.trim()}})),h=i(n.querySelectorAll("#Main .box .topic-link")).map((function(t){return{href:t.href,title:t.textContent.trim()}})),f={value:"Follow",onclick:"location.href = '/signin'"},m={value:"Block",onclick:"location.href = '/signin'"},y=n.querySelectorAll('#Main [type="button"]');if(2===y.length){var p=y[0];f.value="取消特别关注"===p.value?"Unfollow":"Follow",f.onclick=p.getAttribute("onclick");var g=y[1];m.value=g.value,m.onclick=g.getAttribute("onclick")}return{name:c,avatar:o,online:r,joinRank:l,joinTime:s,activityRank:u,socials:d,topics:h,follow:f,block:m}}},{key:"getMemberInfo",value:function(t){var n=this;return this.infoCache[t]?Promise.resolve(this.infoCache[t]):(clearTimeout(this.timeout),new Promise((function(e){n.timeout=setTimeout((function(){fetch(t).then((function(t){return t.text()})).then((function(a){n.infoCache[t]=n.getInfoFromText(a),e(n.infoCache[t])}))}),200)})))}},{key:"getPosFromEvent",value:function(t){var n=t.target,e=this.$card.clientWidth,a=n.getBoundingClientRect(),c=a.x,i=a.y,o=a.width;return{left:c+o-e/2-o/2,top:i+a.height}}},{key:"render",value:function(t,n,e){var a,c;this.$card||(this.$card=document.createElement("div"),this.$card.className="v2ex-card",document.body.appendChild(this.$card)),a=this.$card,c="vc-hide",a.classList.remove(c);var i=this.getPosFromEvent(t),o=i.left,r=i.top;this.$card.style.left="".concat(o,"px"),this.$card.style.top="".concat(r,"px"),n!==this.current&&(this.current=n,this.$card.innerHTML='\n            <div class="vc-inner">\n                <div class="vc-header">\n                    <div class="vc-avatar">\n                        <img src="'.concat(e.avatar,'" alt="').concat(e.name,'" width="48" height="48" />\n                    </div>\n                    <div class="vc-info">\n                        <div class="vc-row">\n                            <span class="vc-name">').concat(e.name,"</span>\n                            ").concat(e.online?'<span class="vc-online">online</span>':"",'\n                        </div>\n                        <div class="vc-row">\n                            <span class="vc-join-rank">No.').concat(e.joinRank,'</span>\n                            <span class="vc-activity-rank ').concat(e.activityRank?"":"vc-hide",'">\n                                Active Today: ').concat(e.activityRank,'\n                            </span>\n                        </div>\n                        <div class="vc-row">\n                            Join: ').concat(e.joinTime,'\n                        </div>\n                    </div>\n                </div>\n                <div class="vc-function">\n                    <div class="vc-item" onclick="').concat(e.follow.onclick,'">\n                        ').concat(e.follow.value,'\n                    </div>\n                    <div class="vc-item" onclick="').concat(e.block.onclick,'">\n                        ').concat(e.block.value,'\n                    </div>\n                </div>\n                <div class="vc-socials ').concat(e.socials.length?"":"vc-hide",'">\n                    ').concat(e.socials.map((function(t){return'<a href="'.concat(t.href,'" title="').concat(t.name,'" target="_blank"><img src="').concat(t.img,'" alt="').concat(e.name,'"  width="16" height="16"/>').concat(t.name,"</a>")})).join(""),'\n                </div>\n                <div class="vc-topics ').concat(e.topics.length?"":"vc-hide",'">\n                    ').concat(e.topics.slice(0,5).map((function(t){return'<a href="'.concat(t.href,'" title="').concat(t.title,'">').concat(t.title,"</a>")})).join(""),"\n                </div>\n            </div>\n        "))}}]),t}())}();
